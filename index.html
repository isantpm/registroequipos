<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Registro de Equipo | Panel</title>

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>

  <style>
    :root {
      --primary: #4f46e5; /* Indigo */
      --primary-dark: #4338ca;
      --bg-gradient: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
      --card-bg: #ffffff;
      --text-main: #1f2937;
      --text-light: #6b7280;
      --radius: 12px;
      --shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
    }

    body {
      font-family: 'Poppins', sans-serif;
      background: var(--bg-gradient);
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      margin: 0;
      padding: 20px;
      color: var(--text-main);
    }

    form {
      background: var(--card-bg);
      padding: 40px;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      width: 100%;
      max-width: 480px;
      transition: transform 0.3s ease;
    }

    h2 {
      text-align: center;
      color: var(--primary);
      margin-bottom: 30px;
      font-weight: 600;
      font-size: 1.8em;
      letter-spacing: -0.5px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      font-weight: 500;
      font-size: 0.9rem;
      margin-bottom: 8px;
      color: var(--text-main);
    }

    input[type="text"],
    input[type="number"],
    textarea {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      box-sizing: border-box;
      font-family: inherit;
      font-size: 14px;
      transition: all 0.3s ease;
      background-color: #f9fafb;
    }

    input:focus, textarea:focus {
      outline: none;
      border-color: var(--primary);
      background-color: #fff;
      box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
    }

    /* Grid para campos cortos */
    .row-2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }

    /* Estilo personalizado para subir archivo */
    .file-upload-wrapper {
      position: relative;
      margin-bottom: 20px;
      text-align: center;
    }

    .file-upload-label {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 30px;
      border: 2px dashed #cbd5e1;
      border-radius: var(--radius);
      cursor: pointer;
      background: #f8fafc;
      transition: all 0.3s;
      color: var(--text-light);
    }

    .file-upload-label:hover {
      background: #eff6ff;
      border-color: var(--primary);
      color: var(--primary);
    }

    .file-upload-label i {
      font-size: 24px;
      margin-bottom: 8px;
    }

    #imagen {
      display: none; /* Ocultar el input real */
    }

    /* Preview de imagen */
    .preview-container {
      position: relative;
      margin-top: 10px;
      border-radius: 8px;
      overflow: hidden;
      display: none; /* Oculto por defecto */
    }
    
    .preview-img {
      width: 100%;
      height: 200px;
      object-fit: cover;
      border-radius: 8px;
    }

    .upload-status {
      font-size: 13px;
      margin-top: 8px;
      text-align: center;
      font-weight: 500;
      display: none;
    }
    
    .status-loading { color: #d97706; }
    .status-success { color: #10b981; }
    .status-error { color: #ef4444; }

    /* Botones */
    .buttons {
      display: flex;
      gap: 15px;
      margin-top: 30px;
    }

    button {
      flex: 1;
      padding: 14px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 15px;
      font-weight: 600;
      transition: transform 0.2s, box-shadow 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    button:active {
      transform: scale(0.98);
    }

    .send-btn {
      background-color: var(--primary);
      color: white;
      box-shadow: 0 4px 6px rgba(79, 70, 229, 0.2);
    }
    .send-btn:hover:not(:disabled) {
      background-color: var(--primary-dark);
      box-shadow: 0 6px 10px rgba(79, 70, 229, 0.3);
    }
    .send-btn:disabled {
      background-color: #9ca3af;
      cursor: not-allowed;
      box-shadow: none;
    }

    .clear-btn {
      background-color: #f3f4f6;
      color: #4b5563;
      border: 1px solid #e5e7eb;
    }
    .clear-btn:hover {
      background-color: #e5e7eb;
      color: #111827;
    }

    .char-count {
      text-align: right;
      font-size: 11px;
      color: #9ca3af;
      margin-top: 4px;
    }

  </style>
</head>
<body>

  <form id="formulario">
    <h2><i class="fas fa-clipboard-list"></i> Registro de Equipo</h2>

    <div class="file-upload-wrapper">
      <label for="imagen" class="file-upload-label">
        <i class="fas fa-cloud-upload-alt"></i>
        <span>Click para subir foto del equipo</span>
      </label>
      <input type="file" id="imagen" accept="image/*" required>
      <input type="hidden" id="imagen_url" name="imagen_url">
      
      <div id="preview-container" class="preview-container"></div>
      <div id="upload-status" class="upload-status"></div>
    </div>

    <div class="form-group">
      <label>Equipo / Maquinaria:</label>
      <input type="text" id="equipo" name="equipo" placeholder="Ej. Excavadora CAT 320" required>
    </div>

    <div class="form-group">
      <label>Localidad o Proyecto:</label>
      <input type="text" id="localidad" name="localidad" placeholder="Ej. Zona Norte - Fase 2" required>
    </div>

    <div class="form-group">
      <label>Operador Responsable:</label>
      <input type="text" id="operador" name="operador" placeholder="Nombre completo" required>
    </div>

    <div class="row-2">
      <div class="form-group">
        <label>Horómetro:</label>
        <input type="number" id="horometro" name="horometro" min="0" placeholder="12345" required>
      </div>
      <div class="form-group">
        <label>Prox. Mant. (Hrs):</label>
        <input type="number" id="mantenimiento" name="mantenimiento" min="0" placeholder="12500" required>
      </div>
    </div>

    <div class="form-group">
      <label>Comentarios Adicionales:</label>
      <textarea id="comentarios" name="comentarios" maxlength="150" rows="3" placeholder="Observaciones sobre el estado..."></textarea>
      <div class="char-count" id="contador">0 / 150</div>
    </div>

    <div class="buttons">
      <button type="button" class="clear-btn" onclick="limpiarFormulario()">
        <i class="fas fa-trash-alt"></i> Limpiar
      </button>
      <button type="submit" id="send-btn" class="send-btn">
        <i class="fas fa-paper-plane"></i> Enviar Registro
      </button>
    </div>
  </form>

  <script>
    // === CONFIGURACIÓN (MISMAS CREDENCIALES) ===
    const EMAILJS_USER_ID = "uJItCmN7zex9RD9cw";
    const EMAILJS_SERVICE_ID = "service_6tjgbhh";
    const EMAILJS_TEMPLATE_ID = "template_7ujeckg";
    const IMGBB_API_KEY = "d62f598ee873c6b448cfd8a9c8dc0622";

    emailjs.init(EMAILJS_USER_ID);

    // === ELEMENTOS ===
    const imagenInput = document.getElementById("imagen");
    const imagenUrlInput = document.getElementById("imagen_url");
    const previewContainer = document.getElementById("preview-container"); // Cambiado ID container
    const uploadStatus = document.getElementById("upload-status");
    const sendBtn = document.getElementById("send-btn");
    const contador = document.getElementById("contador");
    const textarea = document.getElementById("comentarios");

    // === CONTADOR DE CARACTERES ===
    textarea.addEventListener("input", () => {
      contador.textContent = `${textarea.value.length} / 150`;
    });

    // === SUBIDA DE IMAGEN A IMGBB ===
    imagenInput.addEventListener("change", async (e) => {
      const file = e.target.files[0];
      if (!file) return;

      // Validar tamaño (máx 10MB)
      if (file.size > 10 * 1024 * 1024) {
        mostrarStatus("La imagen debe ser menor a 10MB", "error");
        return;
      }

      mostrarStatus("Subiendo a la nube...", "loading");
      previewContainer.style.display = "none"; // Ocultar preview previo mientras carga

      const formData = new FormData();
      formData.append("image", file);
      formData.append("key", IMGBB_API_KEY);

      try {
        const response = await fetch("https://api.imgbb.com/1/upload", {
          method: "POST",
          body: formData
        });

        const data = await response.json();

        if (data.success) {
          imagenUrlInput.value = data.data.url;
          // Mostrar imagen bonita
          previewContainer.innerHTML = `<img src="${data.data.url}" class="preview-img" alt="Vista previa">`;
          previewContainer.style.display = "block";
          
          mostrarStatus("Imagen cargada correctamente", "success");
        } else {
          throw new Error(data.error?.message || "Error al subir imagen");
        }
      } catch (err) {
        mostrarStatus("Error al subir imagen. Intenta de nuevo.", "error");
        console.error(err);
      }
    });

    // Helper para mostrar status con colores
    function mostrarStatus(msg, type) {
      uploadStatus.textContent = msg;
      uploadStatus.style.display = "block";
      uploadStatus.className = "upload-status"; // reset
      if(type === "loading") uploadStatus.classList.add("status-loading");
      if(type === "success") uploadStatus.classList.add("status-success");
      if(type === "error") uploadStatus.classList.add("status-error");
    }

    // === ENVÍO DEL FORMULARIO ===
    document.getElementById("formulario").addEventListener("submit", async function(e) {
      e.preventDefault();

      if (!imagenUrlInput.value) {
        mostrarStatus("Por favor, espera a que la imagen termine de subir.", "error");
        return;
      }

      sendBtn.disabled = true;
      sendBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Enviando...'; // Icono cargando

      const templateParams = {
        equipo: document.getElementById("equipo").value.trim(),
        localidad: document.getElementById("localidad").value.trim(),
        operador: document.getElementById("operador").value.trim(),
        horometro: document.getElementById("horometro").value,
        mantenimiento: document.getElementById("mantenimiento").value,
        comentarios: document.getElementById("comentarios").value,
        imagen_url: imagenUrlInput.value
        
      };

      try {
        await emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, templateParams);
        alert("¡Registro enviado con éxito!"); // Podrías usar SweetAlert2 para que se vea mejor
        limpiarFormulario();
      } catch (error) {
        alert("Error al enviar. Revisa tu conexión.");
        console.error("EmailJS error:", error);
      } finally {
        sendBtn.disabled = false;
        sendBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Enviar Registro';
      }
    });

    // === LIMPIAR FORMULARIO ===
    function limpiarFormulario() {
      document.getElementById("formulario").reset();
      contador.textContent = "0 / 150";
      previewContainer.innerHTML = "";
      previewContainer.style.display = "none";
      imagenUrlInput.value = "";
      uploadStatus.style.display = "none";
    }
  </script>
</body>

</html>
